name: Collect dsBaseClient test suite results

on:
  schedule:
    - cron: "0 */6 * * *"     # every 6 hours
  workflow_dispatch:          # allow manual triggering

jobs:
  collect-results:
    runs-on: ubuntu-latest
    permissions:
      contents: write   # we need to push into testStatus
      
    env:
      REPO_OWNER: ${{ github.repository_owner }}
      TARGET_BRANCH: v6.3.4-dev             # Update to latest version
      TARGET_OUTPUTS: dsbaseclient-logs
      TARGET_PROJECT: dsBaseClient
      TARGET_WORKFLOW: dsBaseClient tests' suite
      
    steps:
      - name: Checkout testStatus
        uses: actions/checkout@v4
        with:
          path: testStatus

      - name: Download artifacts
        uses: dawidd6/action-download-artifact@v6
        with:
          github_token: ${{ secrets.GH_TOKEN }}
          repo: ${{ env.REPO_OWNER }}/${{ env.TARGET_PROJECT }}
          workflow: ${{ env.TARGET_WORKFLOW }}
          workflow_conclusion: success
          branch: ${{ env.TARGET_BRANCH }}
          name: ${{ env.TARGET_OUTPUTS }}
          path: logs-download

      - name: Commit logs into repo
        run: |
          cd testStatus
          branch="${{ env.TARGET_BRANCH }}"
          base_path="../logs-download/logs/dsBaseClient/${{ env.TARGET_BRANCH }}"
          runid=$(ls -d "$base_path"/*/ 2>/dev/null | sort -V | tail -n 1)
          
          mkdir -p logs/dsBaseClient/${branch}/${runid}
          mkdir -p docs/dsBaseClient/${branch}/${runid}
          mkdir -p docs/dsBaseClient/${branch}/${runid}/latest
          
          # clear the latest directory
          rm -rf docs/dsBaseClient/${branch}/${runid}/latest/*
          
          # copy new contents
          cp -r ../logs-download/logs/dsBaseClient/${branch}/${runid}/* logs/dsBaseClient/${branch}/${runid}/
          cp -r ../logs-download/docs/dsBaseClient/${branch}/${runid}/* docs/dsBaseClient/${branch}/${runid}/
          cp -r ../logs-download/docs/dsBaseClient/${branch}/latest/* docs/dsBaseClient/${branch}/latest/

          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"
          git add .
          git commit -m "Results from workflow ${runid}" || echo "No changes"
          git push
